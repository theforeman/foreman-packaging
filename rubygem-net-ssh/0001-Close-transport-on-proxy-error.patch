From 7b415fdcf61d49aa0d749e9d4b9028728f8271db Mon Sep 17 00:00:00 2001
From: Adam Ruzicka <aruzicka@redhat.com>
Date: Wed, 28 Jun 2017 08:50:39 +0200
Subject: [PATCH] Close transport on proxy error

---
 lib/net/ssh.rb               | 3 +++
 lib/net/ssh/proxy/command.rb | 3 ++-
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/lib/net/ssh.rb b/lib/net/ssh.rb
index 899bd7e..8f9db98 100644
--- a/lib/net/ssh.rb
+++ b/lib/net/ssh.rb
@@ -249,6 +249,9 @@ module Net
         transport.close
         raise AuthenticationFailed, "Authentication failed for user #{user}@#{host}"
       end
+    rescue => e
+      transport.close unless transport.nil?
+      raise e
     end
 
     # Returns a hash of the configuration options for the given host, as read
diff --git a/lib/net/ssh/proxy/command.rb b/lib/net/ssh/proxy/command.rb
index b6723e1..5248059 100644
--- a/lib/net/ssh/proxy/command.rb
+++ b/lib/net/ssh/proxy/command.rb
@@ -57,7 +57,8 @@ module Net; module SSH; module Proxy
       begin
         io = IO.popen(command_line, "r+")
         if result = Net::SSH::Compat.io_select([io], nil, [io], 60)
-          if result.last.any?
+          if result.last.any? || io.eof?
+            io.close
             raise "command failed"
           end
         else
-- 
2.9.4

