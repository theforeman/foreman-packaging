#!/usr/bin/env ruby
require 'bundler'
require 'json'
filename = ARGV.shift || 'Gemfile'

HEADER = ARGV.shift || 'specfile'
EXCLUDED_GROUPS = [:test, :development]
EXCLUDED_REQUIRES = {
  'BuildRequires' => [],
  'Requires' => ['activerecord-nulldb-adapter']
}
SCL_PREFIXES = JSON.load(File.read(File.join(__dir__, 'scl_prefixes.json')))

def package(gem)
  return "%{?scl_prefix#{SCL_PREFIXES[gem]}}rubygem(#{gem})"
end

unless File.file?(filename)
  STDERR.puts "File #{filename} is not an existing file"
  exit 1
end

bundler = Dir.chdir(File.dirname(filename)) do
  Bundler.load
end

requires = Hash.new { |h, k| h[k] = {} }

bundler.dependencies.each do |dependency|
  dependency.groups.each do |group|
    next if EXCLUDED_GROUPS.include?(group)

    ['BuildRequires', 'Requires'].each do |req|
      next if EXCLUDED_REQUIRES[req].include?(dependency.name)

      requires[group][req] = [] unless requires[group].key?(req)

      target = requires[group][req]
      name = package(dependency.name)

      dependency.requirement.requirements.each do |op, version|
        if op == '~>'
          target << "#{name} >= #{version}"
          target << "#{name} < #{version.bump}.0"
        elsif op == '>=' && version.to_s == '0'
          target << name
        elsif op != '!=' # != is not supported in RPM
          target << "#{name} #{op} #{version}"
        end
      end
    end
  end
end


requires.each do |group, reqs|
  reqs.each do |req, lines|
    puts "# start #{HEADER} #{group} #{req}"
    lines.each do |line|
      puts "#{req}: #{line}"
    end
    puts "# end #{HEADER} #{group} #{req}"
  end
end
