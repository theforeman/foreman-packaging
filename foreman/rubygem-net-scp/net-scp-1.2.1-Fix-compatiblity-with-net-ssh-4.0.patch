From 3935d683a1bddbd300c5ec3727a1dc4b4f491af8 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?V=C3=ADt=20Ondruch?= <vondruch@redhat.com>
Date: Mon, 27 Feb 2017 13:49:26 +0100
Subject: [PATCH] Fix compatiblity with net-ssh 4.0+

---
 test/test_download.rb | 24 +++++++++++++++---------
 test/test_upload.rb   |  4 +++-
 2 files changed, 18 insertions(+), 10 deletions(-)

diff --git a/test/test_download.rb b/test/test_download.rb
index f3f9a14..f3d9a46 100644
--- a/test/test_download.rb
+++ b/test/test_download.rb
@@ -70,12 +70,12 @@ class TestDownload < Net::SCP::TestCase
     end
 
     error = nil
-    assert_scripted do
-      begin
-        scp.download!("/path/to/remote.txt")
-      rescue
-        error = $!
-      end
+    Net::SSH::Test::Extensions::IO.with_test_extension do
+    begin
+      scp.download!("/path/to/remote.txt")
+    rescue
+      error = $!
+    end
     end
     assert_equal Net::SCP::Error, error.class
     assert_equal "SCP did not finish successfully (1): File not found: /path/to/remote.txt\n", error.message
@@ -116,7 +116,9 @@ class TestDownload < Net::SCP::TestCase
 
   def test_download_io_with_recursive_should_raise_error
     expect_scp_session "-f -r /path/to/remote.txt"
-    assert_raises(Net::SCP::Error) { scp.download!("/path/to/remote.txt", StringIO.new, :recursive => true) }
+    Net::SSH::Test::Extensions::IO.with_test_extension do
+      assert_raises(Net::SCP::Error) { scp.download!("/path/to/remote.txt", StringIO.new, :recursive => true) }
+    end
   end
 
   def test_download_io_with_preserve_should_ignore_preserve
@@ -155,7 +157,9 @@ class TestDownload < Net::SCP::TestCase
       channel.gets_data "D0755 0 remote\n"
     end
 
-    assert_raises(Net::SCP::Error) { scp.download!("/path/to/remote") }
+    Net::SSH::Test::Extensions::IO.with_test_extension do
+      assert_raises(Net::SCP::Error) { scp.download!("/path/to/remote") }
+    end
   end
 
   def test_download_directory_should_create_directory_and_files_locally
@@ -180,7 +184,9 @@ class TestDownload < Net::SCP::TestCase
       channel.sends_ok
     end
 
-    scp.download!("/path/to/remote", "/path/to/local", :recursive => true, :ssh => { :verbose => :debug })
+    Net::SSH::Test::Extensions::IO.with_test_extension do
+      scp.download!("/path/to/remote", "/path/to/local", :recursive => true, :ssh => { :verbose => :debug })
+    end
     assert_equal "a" * 1234, file.io.string
   end
 
diff --git a/test/test_upload.rb b/test/test_upload.rb
index d565df0..5d5d460 100644
--- a/test/test_upload.rb
+++ b/test/test_upload.rb
@@ -156,7 +156,9 @@ class TestUpload < Net::SCP::TestCase
       channel.gets_ok
     end
 
-    assert_raises(Net::SCP::Error) { scp.upload!("/path/to/local", "/path/to/remote") }
+    Net::SSH::Test::Extensions::IO.with_test_extension do
+      assert_raises(Net::SCP::Error) { scp.upload!("/path/to/local", "/path/to/remote") }
+    end
   end
 
   def test_upload_empty_directory_should_create_directory_and_finish
-- 
2.11.1

